<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Pressure Map - Weather Station</title>
    <meta name="description" content="Interactive historical pressure mapping with real-time visualization">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/custom-theme.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/assets/manifest.json">
    <meta name="theme-color" content="#2c5aa0">
    <link rel="apple-touch-icon" href="/assets/weatherbox-icon.png">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">🌤️ Weather Station</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">🏠 Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/intmap">🗺️ Pressure Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/comparison">📊 Compare Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/weatherstat">📈 Statistics</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container fade-in">
        <div class="content-wrapper">
            <div class="text-center mb-4">
                <h1 class="text-gradient">🗺️ Interactive Pressure Map</h1>
                <p class="lead">Visualize historical atmospheric pressure data across locations</p>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">🕰️ Time Controls & Data Options</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="date-select" class="form-label">📅 Select Date</label>
                            <input type="date" id="date-select" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="time-slider" class="form-label">🕓 Time: <span id="time-display">12:00</span></label>
                            <input type="range" id="time-slider" class="form-range" min="0" max="23" value="12" step="1">
                            <div class="d-flex justify-content-between">
                                <small>00:00</small>
                                <small>12:00</small>
                                <small>23:00</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="data-type" class="form-label">📊 Data Display</label>
                            <select id="data-type" class="form-select">
                                <option value="pressure">🌪️ Pressure</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-outline-primary btn-sm me-2" id="play-pause-btn">
                                    ▶️ Play Animation
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" id="reset-btn">
                                    🔄 Reset
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="legend-display" class="d-flex align-items-center">
                                <span class="badge bg-danger me-2">●</span>
                                <small class="me-3">Low Pressure (≤1013.25 hPa)</small>
                                <span class="badge bg-primary me-2">●</span>
                                <small>High Pressure (>1013.25 hPa)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">🌍 Pressure Map Visualization</h3>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; border-radius: 0 0 12px 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-attribution">
        <p class="mb-0">
            <small>Weather data provided by <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo.com</a> (Not Endorsed)</small>
        </p>
    </div>
  <script>
    

    // Initialize the map with data
    async function initializeMap() {
      try {
        // Show loading indicator
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'alert alert-info';
        loadingIndicator.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Loading pressure map data...</span>
          </div>
        `;
        document.querySelector('.content-wrapper').insertBefore(loadingIndicator, document.querySelector('.card'));

        // Use the enhanced weather station API
        let data;
        if (window.weatherStation) {
          data = await window.weatherStation.loadWeatherData();
        } else {
          const response = await fetch('/api/data/weather');
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          const result = await response.json();
          data = result.data;
        }

        if (!data) {
          throw new Error('No weather data available');
        }

        // Remove loading indicator
        loadingIndicator.remove();
        // Initialize the map
        const map = L.map('map').setView([37.0902, -95.7129], 4); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Check available data fields and update dropdown
        function checkAvailableDataFields() {
            if (!data || typeof data !== 'object' || Object.keys(data).length === 0) {
                console.warn('No weather data available for field checking');
                return;
            }
            
            // Get first city's data to check available fields
            const dataValues = Object.values(data);
            if (dataValues.length === 0) {
                console.warn('No cities found in weather data');
                return;
            }
            
            const firstCity = dataValues[0];
            if (!firstCity || !firstCity.hourly) {
                console.warn('First city has no hourly data');
                return;
            }
            
            const hourlyData = firstCity.hourly;
            const dataTypeSelect = document.getElementById('data-type');
            
            // Check if humidity data is available
            const hasHumidity = hourlyData.relativehumidity_2m || 
                               hourlyData.relative_humidity_2m || 
                               hourlyData.humidity;
            
            if (!hasHumidity) {
                // Remove humidity option if not available
                const humidityOption = dataTypeSelect.querySelector('option[value="humidity"]');
                if (humidityOption) {
                    humidityOption.remove();
                    console.warn('Humidity data not available, removing from options');
                }
            }
            
            // Check if temperature data is available
            if (!hourlyData.temperature_2m) {
                const tempOption = dataTypeSelect.querySelector('option[value="temperature"]');
                if (tempOption) {
                    tempOption.remove();
                    console.warn('Temperature data not available, removing from options');
                }
            }
        }

        // Function to determine marker color based on data type and value
        function getColor(value, dataType) {
          switch(dataType) {
            case 'pressure':
              if (value > 1013.25) return 'blue';
              else if (value <= 1013.25) return 'red';
              else return 'green';
            case 'temperature':
              if (value > 20) return 'red';      // Warm (>20°C)
              else if (value > 10) return 'orange'; // Mild (10-20°C)
              else if (value > 0) return 'yellow';  // Cool (0-10°C)
              else return 'blue';                   // Cold (≤0°C)
            case 'humidity':
              if (value > 70) return 'darkblue';    // High humidity (>70%)
              else if (value > 50) return 'blue';   // Medium humidity (50-70%)
              else if (value > 30) return 'green';  // Low humidity (30-50%)
              else return 'orange';                 // Very low humidity (≤30%)
            default:
              return 'gray';
          }
        }

        // Utility function to safely format values based on data type
        function formatValue(value, dataType) {
            if (value == null || isNaN(value) || !isFinite(value)) {
                return 'N/A';
            }
            switch(dataType) {
                case 'pressure':
                    return Number(value).toFixed(1) + ' hPa';
                case 'temperature':
                    return Number(value).toFixed(1) + '°C';
                case 'humidity':
                    return Number(value).toFixed(0) + '%';
                default:
                    return Number(value).toFixed(1);
            }
        }
        
        // Get the appropriate data field based on data type
        function getDataField(cityData, dataType, dateIndex) {
            const hourlyData = cityData.hourly;
            if (!hourlyData || dateIndex < 0) return null;
            
            switch(dataType) {
                case 'pressure':
                    if (hourlyData.pressure_msl && Array.isArray(hourlyData.pressure_msl) && dateIndex < hourlyData.pressure_msl.length) {
                        return hourlyData.pressure_msl[dateIndex];
                    }
                    return null;
                case 'temperature':
                    if (hourlyData.temperature_2m && Array.isArray(hourlyData.temperature_2m) && dateIndex < hourlyData.temperature_2m.length) {
                        return hourlyData.temperature_2m[dateIndex];
                    }
                    return null;
                case 'humidity':
                    // Check multiple possible field names for humidity
                    if (hourlyData.relativehumidity_2m && Array.isArray(hourlyData.relativehumidity_2m) && dateIndex < hourlyData.relativehumidity_2m.length) {
                        return hourlyData.relativehumidity_2m[dateIndex];
                    } else if (hourlyData.relative_humidity_2m && Array.isArray(hourlyData.relative_humidity_2m) && dateIndex < hourlyData.relative_humidity_2m.length) {
                        return hourlyData.relative_humidity_2m[dateIndex];
                    } else if (hourlyData.humidity && Array.isArray(hourlyData.humidity) && dateIndex < hourlyData.humidity.length) {
                        return hourlyData.humidity[dateIndex];
                    } else {
                        // If no humidity data available, return null
                        console.warn('Humidity data not available in weather data');
                        return null;
                    }
                default:
                    return null;
            }
        }
        
        // Update legend based on data type
        function updateLegend(dataType) {
            const legendDisplay = document.getElementById('legend-display');
            let legendHTML = '';
            
            switch(dataType) {
                case 'pressure':
                    legendHTML = `
                        <span class="badge bg-danger me-2">●</span>
                        <small class="me-3">Low Pressure (≤1013.25 hPa)</small>
                        <span class="badge bg-primary me-2">●</span>
                        <small>High Pressure (>1013.25 hPa)</small>
                    `;
                    break;
                case 'temperature':
                    legendHTML = `
                        <span class="badge bg-danger me-2">●</span>
                        <small class="me-2">Hot (>20°C)</small>
                        <span style="background-color: orange; color: white;" class="badge me-2">●</span>
                        <small class="me-2">Mild (10-20°C)</small>
                        <span style="background-color: #ffd700; color: black;" class="badge me-2">●</span>
                        <small class="me-2">Cool (0-10°C)</small>
                        <span class="badge bg-primary me-2">●</span>
                        <small>Cold (≤0°C)</small>
                    `;
                    break;
                case 'humidity':
                    legendHTML = `
                        <span style="background-color: darkblue;" class="badge me-2">●</span>
                        <small class="me-2">High (>70%)</small>
                        <span class="badge bg-primary me-2">●</span>
                        <small class="me-2">Medium (50-70%)</small>
                        <span class="badge bg-success me-2">●</span>
                        <small class="me-2">Low (30-50%)</small>
                        <span style="background-color: orange;" class="badge me-2">●</span>
                        <small>Very Low (≤30%)</small>
                    `;
                    break;
            }
            
            legendDisplay.innerHTML = legendHTML;
        }

        // Animation control variables
        let animationInterval = null;
        let isAnimating = false;
        
        // Function to update map markers based on selected date and time
        function updateMap() {
            const selectedDate = document.getElementById('date-select').value;
            const timeSlider = document.getElementById('time-slider');
            const selectedHour = parseInt(timeSlider.value);
            const selectedTime = selectedHour.toString().padStart(2, '0') + ':00';
            const selectedDateTime = `${selectedDate}T${selectedTime}`;
            const dataType = document.getElementById('data-type').value;
            
            // Update time display
            document.getElementById('time-display').textContent = selectedTime;
            
            // Update legend
            updateLegend(dataType);

            // Convert the data object to array while preserving city names
            const filteredData = Object.entries(data)
                .filter(([cityName, cityData]) => {
                    const hourlyData = cityData.hourly;
                    // Find the index of the matching datetime in the time array
                    const dateIndex = hourlyData.time.findIndex(timeString => 
                        timeString === selectedDateTime
                    );
                    // Only include points where we found a matching time and valid data
                    if (dateIndex === -1) return false;
                    const value = getDataField(cityData, dataType, dateIndex);
                    return value != null && !isNaN(value) && isFinite(value);
                })
                .map(([cityName, cityData]) => {
                    const dateIndex = cityData.hourly.time.findIndex(timeString => 
                        timeString === selectedDateTime
                    );
                    
                    const value = getDataField(cityData, dataType, dateIndex);
                    
                    // Return the properly structured data object
                    return {
                        city: cityName,
                        latitude: cityData.latitude,
                        longitude: cityData.longitude,
                        value: value,
                        dataType: dataType
                    };
                });

            // Clear existing markers 
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });

            // Add markers for the filtered data
            filteredData.forEach(point => {
                const dataTypeLabel = dataType.charAt(0).toUpperCase() + dataType.slice(1);
                L.circleMarker([point.latitude, point.longitude], {
                    radius: 8,
                    fillColor: getColor(point.value, dataType),
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map)
                  .bindPopup(`<b>${point.city}</b><br>${dataTypeLabel}: ${formatValue(point.value, dataType)}`);
            });
        }
        
        // Animation functions
        function startAnimation() {
            if (isAnimating) return;
            
            isAnimating = true;
            const playButton = document.getElementById('play-pause-btn');
            playButton.innerHTML = '⏸️ Pause';
            
            const timeSlider = document.getElementById('time-slider');
            
            animationInterval = setInterval(() => {
                let currentHour = parseInt(timeSlider.value);
                currentHour = (currentHour + 1) % 24;
                timeSlider.value = currentHour;
                updateMap();
            }, 500); // Update every 500ms
        }
        
        function stopAnimation() {
            if (!isAnimating) return;
            
            isAnimating = false;
            const playButton = document.getElementById('play-pause-btn');
            playButton.innerHTML = '▶️ Play Animation';
            
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }
        
        function toggleAnimation() {
            if (isAnimating) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }
        
        function resetControls() {
            stopAnimation();
            document.getElementById('time-slider').value = 12;
            document.getElementById('data-type').value = 'pressure';
            
            // Set date to yesterday to ensure data is available
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date-select').value = yesterday.toISOString().split('T')[0];
            
            updateMap();
        }

        // Set default date to yesterday to ensure data is available
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('date-select').value = yesterday.toISOString().split('T')[0];
        
        // Check available data fields and update dropdown
        checkAvailableDataFields();
        
        // Add event listeners to controls
        document.getElementById('date-select').addEventListener('change', updateMap);
        document.getElementById('time-slider').addEventListener('input', updateMap);
        document.getElementById('data-type').addEventListener('change', updateMap);
        document.getElementById('play-pause-btn').addEventListener('click', toggleAnimation);
        document.getElementById('reset-btn').addEventListener('click', resetControls);
        
        // Initial map update
        updateMap();

      } catch (error) {
        console.error('Error loading pressure map:', error);
        
        // Show error message
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger';
        errorAlert.innerHTML = `
          <h5>⚠️ Unable to Load Weather Data</h5>
          <p>Error: ${error.message}</p>
          <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
            🔄 Retry
          </button>
        `;
        document.querySelector('.content-wrapper').appendChild(errorAlert);
      }
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeMap);
    } else {
      initializeMap();
    } 
  </script>
</body>
</html>
